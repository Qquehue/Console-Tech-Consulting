<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="../css/img/logo2.png">
    <link rel="stylesheet" href="../css/body.css">
    <link rel="stylesheet" href="../css/root.css">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/maquina.css">
    <link rel="stylesheet" href="../css/cabecalho_dash.css">
    <link rel="icon" href="../css/img/icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/funcoes.js"></script>

    <title>Detalhes do totem</title>
</head>

<body onload="validarSessao(), mostrarInfos(), mostrarEspecificacao, obterDadosGrafico(1)">

<!-- Início cabeçalho -->

    <div class="cabecalho">
        <div class="container_cabecalho">
            <div class="itens_cabecalho">
                <img src="../css/img/logo branco.png" alt="Logo do Site" class="logo_cabecalho">
                <p class="texto" id="nome"></p>
                <img src="../css/img/analista.png" alt="" id="foto_dash">
                <!-- <a href="index.html"><img src="css/img/saida.png" alt="" id="exit"></a> -->
            </div>
        </div>
    </div>

<!-- Fim cabeçalho -->

<!-- --------------------------------------------------------------------------------------------------------- -->

<!-- Início especificações -->
    <div id="dados">
        <div id="especificacoes">
            <div id="pc">
                <img class="estado" src="../css/img/computador_inativo.png" alt="Imagem computador">
            </div>    
            <div id="informacoes">
                <p class="info">Informações:</p>
                <div class="info1">
                    <b>id: </b><span class="dado" id="idMaquina"> </span>
                </div>
                <div>
                    <b>CPU: </b> <span class="dado" id="modeloCpu">  </span>
                </div>
                <div>
                    <b>RAM: </b> <span class="dado" id="ram"> </span>
                </div>
                <div class="info1">
                    <b>Data da implantação: </b> <span class="dado" id="data"> </span>
                </div>
                <div>
                    <b>Linha: </b> <span class="dado" id="linha"> </span>
                </div>
                <div>
                    <b>Estação: </b> <span class="dado" id="estacao"> </span>
                </div>
            </div>

            <div id="legenda">
                <div class="itens_legenda">
                    <div class="kpi">
                        <div class="alerta bom" onmouseover="mostrarBom()" onmouseleave="sumirDiv()"></div>
                    </div>
                    <div class="kpi">
                        <div class="alerta atencao" id="atencao" onmouseover="mostrarAtencao()" onmouseleave="sumirDiv()"></div>
                    </div>
                    <div class="kpi">
                        <div class="alerta ruim" id="ruim" onmouseover="mostrarRuim()" onmouseleave="sumirDiv()"></div>
                    </div>
                    <div class="kpi">
                        <div class="alerta inativo" id="inativo" onmouseover="mostrarInativo()" onmouseleave="sumirDiv()"></div>
                    </div>
                </div>
            </div>

            <div id="estados" style="display: none;">
                <div id="p_estados">

                </div>
            </div>

        </div>
        <div id="graficos">
            <div id="graficos_cima">
                <!-- GRAFICO CPU -->
                <div class="grafico" id="graficoCpu">
                    <canvas id="myChart1"></canvas>
                </div>
                <!-- GRAFICO HD -->
                <div class="grafico" id="graficoRam">
                    <canvas id="myChart2"></canvas>
                </div>
            </div>

            <div id="graficos_baixo">
                <!-- GRAFICO RAM -->
                <div class="grafico" id="processos">
                </div>
                </div>
            </div>
        </div>
    </div>
<!-- Fim especificações -->

<!-- --------------------------------------------------------------------------------------------------------- -->

<!-- Início legenda -->

    <button id="btn_relatorio" onclick="btn_relatorio()">Abrir chamado</button>
    <!-- <a href="help.html"> <img src="css/img/help.png" id="help"></img> </a>
    <a href="dashboard.html"> <img src="css/img/casa.png" id="casa"></img> </a> -->

<!-- Fim legenda -->

<!-- --------------------------------------------------------------------------------------------------------- -->

</body>
</html>
<script>

    function mostrarEspecificacao(idMaquina) {
        fetch(`/dash/listar/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            console.log("ESTOU NO THEN DO listar()!")
            console.log(resposta)

            if (resposta.ok) {
                console.log(resposta[0].totalMemoria);
                localStorage.ram = resposta[0].totalMemoria;   
                localStorage.modeloCPU = resposta[0].modeloCPU;
                localStorage.dataCadastro = resposta[0].dataCadastro;
                resposta.json().then(json => {
                    console.log(json);   
                });
            } else {
                console.log("Houve um erro ao tentar realizar o listar!");
                resposta.text().then(texto => {
                    console.error(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }
    function btn_relatorio() {
        window.open('chamado.html')
    }
    function mostrarInfos() {
        idMaquina.innerHTML = localStorage.idMaquina;
        modeloCpu.innerHTML = localStorage.modeloCpu;
        ram.innerHTML = localStorage.ram;
        data.innerHTML = localStorage.dataCadastro;
        linha.innerHTML = sessionStorage.COR_LINHA;
        estacao.innerHTML = sessionStorage.NOME_ESTACAO;
    }
</script>
<script>
    function obterDadosGrafico(idAquario) {
            console.log("entrei no obter")
            // if (proximaAtualizacao != undefined) {
            //     clearTimeout(proximaAtualizacao);
            // }

            fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
                if (response.ok) {
                    response.json().then(function (resposta) {
                        console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                        resposta.reverse();

                        plotarGrafico(resposta, idAquario);
                    });
                } else {
                    console.error('Nenhum dado encontrado ou erro na API');
                }
            })
                .catch(function (error) {
                    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                });
        }

        function plotarGrafico(resposta, idCaminhao) {
            console.log('iniciando plotagem do gráfico...');

            var dados = {
                labels: [],
                datasets: [
                    {
                        // joga as temperaturas
                        yAxisID: 'y-temperatura',
                        label: 'Uso CPU',
                        borderColor: '#FFF',
                        backgroundColor: '#32b9cd8f',
                        fill: true,
                        // dados da temperatura
                        data: []
                    }
                ]
            };

            for (i = 0; i < resposta.length; i++) {
                var registro = resposta[i];
                let horario = (registro.upTime).toString();
                let horarioModificado = horario.slice(11,19);
                console.log(horarioModificado)
                // verificar se esta referenciado
                // console.log(registro)
                dados.labels.push(horarioModificado);
                dados.datasets[0].data.push(registro.usoCPU);
            }

            console.log(JSON.stringify(dados));

            //  verificar nome ctx
            var ctx = document.querySelector("#myChart1");
            var grafico_linha2 = new Chart(ctx, {
                type: 'line',
                data: dados,
                // options: {
                //     responsive: true,
                //     animation: { duration: 500 },
                //     hoverMode: 'index',
                //     stacked: false,
                //     title: {
                //         display: false,
                //         text: 'Dados capturados'
                //     },
                //     scales: {
                //         yAxes: [{
                //             // type: 'linear',
                //             // display: true,
                //             // position: 'left',
                //             // ticks: {
                //             //     beginAtZero: true,
                //             //     max: 25,
                //             //     min: -25
                //             // }
                //         }],
                //     }
                // }
            });

            // setTimeout(() => atualizarGrafico(idCaminhao, dados), 2000);
        }


        function atualizarGrafico(idCaminhao, dados) {

    fetch(`/medidas/tempo-real/${idCaminhao}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {

                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                console.log(`Dados atuais do gráfico: ${dados}`);

                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento
                
                dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                window.grafico_linha.update();

                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idCaminhao, dados), 3000);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idCaminhao, dados), 3000);
        }
    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });

    }

    function mostrarBom() {
        estados.style.display = 'block';
        p_estados.innerHTML = "Consumo cpu < 60% e Consumo de Ram < 60%"
    }
    function mostrarAtencao() {
        estados.style.display = 'block';
        p_estados.innerHTML = "Consumo cpu entre 61% e 70% Consumo de Ram < 60%"
    }
    function mostrarRuim() {
        estados.style.display = 'block';
        p_estados.innerHTML = ""
    }
    function mostrarInativo() {
        estados.style.display = 'block';
        p_estados.innerHTML = ""
    }
    function sumirDiv() {
        estados.style.display = 'none';
    }

    // const ctx1 = document.getElementById('myChart1').getContext('2d');
    // const myChart1 = new Chart(ctx1, {
    //     type: 'line',
    //     data: {
    //         labels: [
    //             '12:00',
    //             '13:00',
    //             '14:00',
    //             '15:00',
    //             '16:00',
    //             '17:00',
    //             '18:00',
    //             '19:00',
    //             '20:00',
    //             '21:00',
    //             '22:00',
    //             '23:00',
    //         ],
    //         datasets: [{
    //             label: 'Uso CPU (%)',
    //             data: [45, 10, 80, 8, 53, 10, 70, 16, 75, 28, 59, 90],
    //             backgroundColor: [
    //                 'lightblue',
    //             ],
    //             borderColor: [
    //                 'lightskyblue',
    //             ],
    //             borderWidth: 1
    //         }]
    //     },
    //     options: {
    //         scales: {
    //             y: {
    //                 // beginAtZero: false
    //                 min: 0,
    //                 max: 100    
                    
    //             }
    //         }
    //     }
    // });

    // const ctx2 = document.getElementById('myChart2').getContext('2d');
    // const myChart2 = new Chart(ctx2, {
    //     type: 'line',
    //     data: {
    //         labels: [
    //             '12:00',
    //             '13:00',
    //             '14:00',
    //             '15:00',
    //             '16:00',
    //             '17:00',
    //             '18:00',
    //             '19:00',
    //             '20:00',
    //             '21:00',
    //             '22:00',
    //             '23:00'
    //             ],
    //         datasets: [{
    //             label: 'Uso de memória Ram(%)',
    //             data: [5, 30, 10, 80, 20, 50, 89, 54, 78, 20, 50, 38],
    //             backgroundColor: [
    //                 'purple'
    //             ],
    //             borderColor: [
    //                 'purple'
    //             ],
    //             borderWidth: 1
    //         }]
    //     },
    //     options: {
    //         scales: {
    //             y: {
    //                 // beginAtZero: false,
    //                 min: 0,
    //                 max: 100
                    
    //             }
    //         }
    //     }
    // });
</script>